<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Carrito - Café San Juan</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="img/logo-rincon.png">
    <link rel="shortcut icon" type="image/png" href="img/logo-rincon.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
 <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
 
    <!-- Fix para codificación de caracteres -->
    <script src="fix-charset.js"></script>

    <!-- VALIDACIÓN DE AUTENTICACIÓN -->
    <script>
  // Verificar autenticación ANTES de cargar cualquier cosa
        (function() {
   const usuarioTemp = JSON.parse(localStorage.getItem("usuario"));
            if (!usuarioTemp) {
   // Guardar la URL actual para redirigir después del login
      sessionStorage.setItem("redirectAfterLogin", "carrito.html");
     // Redirigir a la página principal
             window.location.href = "index.html";
            }
      })();
    </script>
</head>
<body>

    <!-- NAVBAR -->
 <div id="navbar-container"></div>
    <script>
 fetch("components/navbar.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("navbar-container").innerHTML = html;
 const script = document.createElement("script");
    script.src = "js/navbar.js";
   document.body.appendChild(script);
  });
    </script>

 <!-- AUTH MODAL -->
  <div id="auth-modal-container"></div>
    <script>
  fetch("components/auth-modal.html")
  .then(res => res.text())
   .then(html => {
 document.getElementById("auth-modal-container").innerHTML = html;
  })
  .catch(error => {
 console.error("Error cargando el modal de autenticación:", error);
 });
    </script>

    <!-- NOTIFICATION MODAL -->
    <div id="notification-modal-container"></div>
    <script>
        fetch("components/notification-modal.html")
   .then(res => res.text())
        .then(html => {
document.getElementById("notification-modal-container").innerHTML = html;
})
          .catch(error => {
      console.error("Error cargando el modal de notificaciones:", error);
     });
    </script>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmation-modal-container"></div>
    <script>
 fetch("components/confirmation-modal.html")
    .then(res => res.text())
  .then(html => {
  document.getElementById("confirmation-modal-container").innerHTML = html;
 })
     .catch(error => {
                console.error("Error cargando el modal de confirmación:", error);
         });
    </script>

 <div class="container my-5">
      <div class="row">
    <div class="col-lg-10 mx-auto">
   <div class="card">
    <div class="card-header bg-primary text-white">
         <h4 class="mb-0">
  <i class="bi bi-cart3"></i> Mi Carrito de Reservas
 </h4>
    </div>
   <div class="card-body">
 <!-- Mensaje cuando esta vacío -->
  <div id="carrito-vacio" class="text-center py-5" style="display: none;">
    <i class="bi bi-cart-x display-1 text-muted"></i>
 <h5 class="text-muted mt-3">Tu carrito está vacío</h5>
    <p class="text-muted">Agrega algunas reservas para verlas aquí</p>
 <a href="reservas.html" class="btn btn-primary">
  <i class="bi bi-plus-circle"></i> Hacer una reserva
 </a>
   </div>

    <!-- Lista de reservas en el carrito -->
     <div id="lista-carrito">

     <!-- SECCION DE PROMOCIONES -->
      <div class="row mb-4">
       <div class="col-12">
   <div class="card border-success">
 <div class="card-header bg-success text-white">
      <h6 class="mb-0">
    <i class="bi bi-percent"></i> Promociones Disponibles
     </h6>
      </div>
   <div class="card-body" id="promociones-container">
    <div class="text-center">
    <div class="spinner-border text-success" role="status">
   <span class="visually-hidden">Cargando promociones...</span>
    </div>
    </div>
   </div>
   </div>
   </div>
  </div>
     
 <!-- Controles de selección -->
    <div class="row mb-3">
  <div class="col-md-6">
    <div id="info-seleccion" class="mb-2">
   <span class="text-muted">No hay reservas seleccionadas</span>
 </div>
  <div class="btn-group" role="group">
    <button id="btn-seleccionar-todas" class="btn btn-sm btn-outline-primary" disabled>
  <i class="bi bi-check-all"></i> Seleccionar Todas
  </button>
   <button id="btn-deseleccionar-todas" class="btn btn-sm btn-outline-secondary" disabled>
    <i class="bi bi-x-square"></i> Deseleccionar Todas
    </button>
  </div>
      </div>
  </div>

<div class="table-responsive">
<table class="table table-hover">
<thead class="table-light">
   <tr>
   <th>Selección</th>
 <th>Mesa</th>
     <th>Fecha</th>
     <th>Hora</th>
 <th>Personas</th>
       <th>Precio</th>
      <th>Acciones</th>
  </tr>
    </thead>
     <tbody id="carrito-items">
 <!-- Los items del carrito se cargan aquí -->
   </tbody>
</table>
    </div>

 <!-- Resumen del carrito CON PROMOCIONES -->
   <div class="row mt-4">
    <div class="col-md-6 offset-md-6">
  <div class="card bg-light">
    <div class="card-body">
   <h6 class="card-title">Resumen de Seleccionadas</h6>
    
<!-- Total de reservas SELECCIONADAS -->
 <div class="d-flex justify-content-between">
    <span>Reservas seleccionadas:</span>
    <strong id="total-reservas-seleccionadas">0</strong>
  </div>
  
  <!-- Total de reservas TOTALES en carrito -->
 <div class="d-flex justify-content-between text-muted">
    <small>Total en carrito:</small>
    <small id="total-reservas">0</small>
  </div>
      
   <hr class="my-2">
    
 <!-- Subtotal (sin descuento ni IVA) -->
 <div class="d-flex justify-content-between mt-2">
   <span>Subtotal:</span>
 <span id="subtotal-carrito">$0.00</span>
    </div>

  <!-- Descuento por promocion -->
    <div class="d-flex justify-content-between" id="descuento-row" style="display: none;">
    <span class="text-success">Descuento (<span id="porcentaje-descuento">0</span>%):</span>
  <span class="text-success" id="monto-descuento">-$0.00</span>
  </div>

<!-- Subtotal con descuento -->
  <div class="d-flex justify-content-between" id="subtotal-descuento-row" style="display: none;">
   <span>Subtotal c/descuento:</span>
   <span id="subtotal-con-descuento">$0.00</span>
  </div>
    
   <!-- IVA (7%) -->
<div class="d-flex justify-content-between">
   <span>IVA (11.5%):</span>
     <span id="iva-carrito">$0.00</span>
  </div>
 
    <!-- Total final -->
  <hr>
   <div class="d-flex justify-content-between">
  <strong>Total a pagar:</strong>
  <strong id="total-carrito" class="text-primary">$0.00</strong>
   </div>
   
  <hr>
<div class="d-grid gap-2">
   <button id="btn-confirmar-carrito" class="btn btn-success" disabled>
     <i class="bi bi-check-circle"></i> Confirmar Seleccionadas
  </button>
    <!-- NUEVO: Boton para generar factura -->
    <button id="btn-generar-factura" class="btn btn-primary" disabled>
 <i class="bi bi-receipt"></i> Generar Factura
    </button>
   <button id="btn-vaciar-carrito" class="btn btn-outline-danger" disabled>
  <i class="bi bi-trash"></i> Vaciar Carrito
    </button>
   </div>
   </div>
      </div>
  </div>

</div> <!-- FIN de lista-carrito -->

</div> <!-- FIN de card-body principal -->
</div> <!-- FIN de card principal -->

<!-- NUEVA SECCIÓN: RESERVAS CONFIRMADAS (FUERA DEL CARD PRINCIPAL) -->
<div class="row mt-4">
  <div class="col-lg-10 mx-auto">
<div class="card border-success">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="bi bi-check-circle"></i> Mis Reservas Confirmadas
        </h5>
       <small>Reservas que ya han sido confirmadas con método de pago</small>
      </div>
    <div class="card-body">
    <!-- Mensaje cuando no hay reservas confirmadas -->
   <div id="reservas-confirmadas-vacio" style="display: none;">
     <div class="text-center text-muted py-4">
     <i class="bi bi-calendar-check" style="font-size: 3rem;"></i>
<h6>No tienes reservas confirmadas</h6>
   <p>Las reservas aparecerán aquí cuando las confirmes con un método de pago.</p>
        </div>
        </div>

     <!-- Lista de reservas confirmadas -->
  <div id="lista-reservas-confirmadas">
      <!-- Controles de selección para reservas confirmadas -->
   <div class="row mb-3" id="controles-confirmadas" style="display: none;">
   <div class="col-md-6">
      <div id="info-seleccion-confirmadas" class="mb-2">
     <span class="text-muted">No hay reservas confirmadas seleccionadas</span>
         </div>
       <div class="btn-group" role="group">
  <button id="btn-seleccionar-todas-confirmadas" class="btn btn-sm btn-outline-success">
          <i class="bi bi-check-all"></i> Seleccionar Todas
         </button>
      <button id="btn-deseleccionar-todas-confirmadas" class="btn btn-sm btn-outline-secondary">
 <i class="bi bi-x-square"></i> Deseleccionar Todas
 </button>
    </div>
       </div>
  </div>

          <!-- Tabla de reservas confirmadas -->
          <div class="table-responsive" id="tabla-confirmadas" style="display: none;">
      <table class="table table-hover">
    <thead class="table-success">
      <tr>
 <th>Selección</th>
      <th>Mesa</th>
  <th>Fecha</th>
        <th>Hora</th>
   <th>Personas</th>
   <th>Método de Pago</th>
      <th>Total</th>
    <th>Estado</th>
    </tr>
  </thead>
  <tbody id="reservas-confirmadas-items">
           <!-- Los items de reservas confirmadas se cargan aquí -->
    </tbody>
  </table>
          </div>

          <!-- Resumen de reservas confirmadas seleccionadas -->
          <div class="row mt-4" id="resumen-confirmadas" style="display: none;">
            <div class="col-md-6 offset-md-6">
    <div class="card bg-success bg-opacity-10 border-success">
             <div class="card-body">
              <h6 class="card-title text-success">Resumen de Seleccionadas</h6>

       <div class="d-flex justify-content-between">
       <span>Reservas confirmadas seleccionadas:</span>
         <strong id="total-confirmadas-seleccionadas">0</strong>
             </div>

      <hr>

   <div class="d-flex justify-content-between">
     <span>Subtotal:</span>
              <span id="subtotal-confirmadas">$0.00</span>
     </div>

 <div class="d-flex justify-content-between">
   <span>IVA (11.5%):</span>
  <span id="iva-confirmadas">$0.00</span>
             </div>

             <div class="d-flex justify-content-between border-top pt-2">
       <strong>Total:</strong>
      <strong class="text-success" id="total-confirmadas">$0.00</strong>
    </div>

     <!-- Boton para generar factura de confirmadas -->
       <div class="text-center mt-3">
      <button id="btn-generar-factura-confirmadas" class="btn btn-success" disabled>
          <i class="bi bi-receipt"></i> Generar Factura de Confirmadas
        </button>
   </div>
       </div>
  </div>
      </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> <!-- FIN de seccion-reservas-confirmadas -->

<!-- NUEVA SECCIÓN: FACTURA GENERADA -->
<div class="row mt-4">
<div class="col-lg-10 mx-auto">
<div class="card border-primary" id="seccion-factura" style="display: none;">
      <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
<i class="bi bi-receipt"></i> Factura Generada
        </h5>
      </div>
      <div class="card-body">
     <!-- Información básica de la factura -->
  <div class="row mb-3">
<div class="col-md-6">
     <h6>Información de Factura</h6>
     <p class="mb-1"><strong>Número:</strong> <span id="factura-numero"></span></p>
  <p class="mb-1"><strong>Fecha:</strong> <span id="factura-fecha"></span></p>
    <p class="mb-1"><strong>Estado:</strong> <span id="factura-estado" class="badge"></span></p>
     <p class="mb-1"><strong>Método de Pago:</strong> <span id="factura-metodo-pago"></span></p>
     </div>
   <div class="col-md-6">
   <h6>Cliente</h6>
   <p class="mb-1"><strong>Nombre:</strong> <span id="factura-cliente"></span></p>
    <p class="mb-1"><strong>Teléfono:</strong> <span id="factura-telefono"></span></p>
  <p class="mb-1"><strong>Email:</strong> <span id="factura-email"></span></p>
   </div>
  </div>

    <!-- Detalles de la factura -->
        <h6>Detalle de Reservas</h6>
 <div class="table-responsive">
   <table class="table table-sm">
    <thead class="table-light">
    <tr>
    <th>Descripción</th>
    <th>Cantidad</th>
  <th>Precio Unit.</th>
 <th>Subtotal</th>
</tr>
</thead>
<tbody id="factura-detalles">
    </tbody>
        </table>
   </div>

    <!-- Totales de factura -->
    <div class="row">
   <div class="col-md-6 offset-md-6">
   <div class="table-responsive">
<table class="table table-sm">
     <tr>
     <td><strong>Subtotal:</strong></td>
<td class="text-end"><span id="factura-subtotal"></span></td>
   </tr>
     <tr class="text-success" id="factura-descuento-row" style="display: none;">
<td><strong>Descuento:</strong></td>
   <td class="text-end"><span id="factura-descuento"></span></td>
 </tr>
  <tr>
    <td><strong>IVA (12%):</strong></td>
   <td class="text-end"><span id="factura-iva"></span></td>
     </tr>
 <tr class="table-primary">
   <td><strong>Total:</strong></td>
  <td class="text-end"><strong><span id="factura-total"></span></strong></td>
          </tr>
     </table>
  </div>
    </div>
      </div>

<!-- Acciones de factura -->
  <div class="text-center mt-3">
   <button id="btn-descargar-factura" class="btn btn-outline-primary">
 <i class="bi bi-download"></i> Descargar Factura
  </button>
     <button id="btn-nueva-factura" class="btn btn-outline-secondary">
 <i class="bi bi-plus-circle"></i> Nueva Factura
 </button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Modal de Confirmación CON PROMOCIONES -->
    <div class="modal fade" id="modalConfirmar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
   <div class="modal-header">
    <h5 class="modal-title">Confirmar Reservas Seleccionadas</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
<div class="modal-body">
    <p>¿Estás seguro de que deseas confirmar las reservas seleccionadas?</p>
      
    <!-- Mostrar promoción aplicada -->
  <div id="promocion-aplicada-info" class="alert alert-success" style="display: none;">
 <i class="bi bi-percent"></i>
<strong>Promoción aplicada:</strong> <span id="promocion-nombre"></span>
     <br><strong>Descuento:</strong> <span id="promocion-porcentaje"></span>%


    <div class="alert-warning">
  <strong>¡Aviso!</strong> Verifique los detalles antes de confirmar.
</div>

  </div>

  <div class="alert alert-info">
  <i class="bi bi-info-circle"></i>
   <strong>Nota:</strong> Al confirmar, las reservas cambiarán a estado "CONFIRMADA" y se aplicará el IVA de 12%.
      </div>
  <div class="form-group mt-3">
 <label for="metodo-pago" class="form-label">Método de Pago:</label>
     <select id="metodo-pago" class="form-select" required>
     <option value="Seleccionar metodo de pago">Seleccionar método de pago</option>
  <option value="Efectivo">Efectivo</option>
 <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
 <option value="Transferencia">Transferencia Bancaria</option>
   <option value="ATH_Movil">ATH Móvil</option>
 </select>
     </div>
     </div>
     <div class="modal-footer">
     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
   <button type="button" id="confirmar-pago" class="btn btn-success">
    <i class="bi bi-credit-card"></i> Confirmar Pago
    </button>
</div>
</div>
    </div>
    </div>

    <!-- NUEVO: Modal para pago bancario -->
    <div class="modal fade" id="modalPagoBancario" tabindex="-1">
      <div class="modal-dialog">
      <div class="modal-content">
     <div class="modal-header">
    <h5 class="modal-title">Pago Bancario - Restaurante</h5>
       <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
       <div class="modal-body">
   <div id="pago-bancario-info">
    <p>Se realizará una transferencia bancaria con los siguientes datos:</p>
      
       <div class="alert alert-info">
  <strong>Total a pagar:</strong> <span id="monto-pago-bancario">$0.00</span>
   </div>

        <div class="form-group mb-3" style="display: none;">
 <label for="cedula-cliente" class="form-label">Cédula del Cliente:</label>
      <input type="text" id="cedula-cliente" class="form-control" placeholder="Ingresa tu cédula">
      <small class="text-muted">Se usará para procesar la transacción bancaria</small>
   </div>

  <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
   <strong>Nota:</strong> La transacción se procesará desde tu cuenta bancaria registrada hacia la cuenta del restaurante.
  </div>

  <div id="estado-pago-bancario" style="display: none;">
<div id="mensaje-pago-bancario"></div>
    </div>
    </div>
     </div>
       <div class="modal-footer">
       <button type="button" id="confirmar-pago-bancario" class="btn btn-success">
<i class="bi bi-credit-card"></i> Procesar Pago
       </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>
    <script>
    fetch("components/footer.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("footer-container").innerHTML = html;
   })
        .catch(error => {
  console.error("Error cargando el footer:", error);
        });
    </script>

 <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/global-init.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/auth.js"></script>
  <script src="js/carrito.js"></script>
</body>
</html>
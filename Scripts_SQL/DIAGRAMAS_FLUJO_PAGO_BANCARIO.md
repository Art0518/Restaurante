# ?? DIAGRAMA DE FLUJO - PAGO BANCARIO

## ?? FLUJO COMPLETO

```
???????????????????????????????????????????????????????????????
?       USUARIO EN CARRITO.HTML    ?
???????????????????????????????????????????????????????????????
         ?
         ? Selecciona 1+ reservas
    ?
          ????????????????????????????????
          ?  ¿Hay reservas seleccionadas??
      ????????????????????????????????
   ? SÍ
            ?
    ??????????????????????????????????????????
    ?      Clic en "PAGADAS AHORA"           ?
    ?  (btn-confirmar-carrito)       ?
    ????????????????????????????????????????
                 ?
            ?
    ???????????????????????????????????????????????????????
    ? procesarPagoBancario()                  ?
    ? ?? Validar reservas seleccionadas            ?
    ? ?? Calcular totalAPagar              ?
    ? ?? Mostrar modalPagoBancario  ?
    ? ?? Mostrar monto calculado?
    ???????????????????????????????????????????????????????
  ?
              ?
    ?????????????????????????????????????
    ?   MODAL PAGO BANCARIO ABIERTO ?
    ?          ?
    ?   Total: $150.00      ?
    ?   Cédula: [____________]    ?
    ?     ?
    ? [Cancelar] [Procesar Pago]        ?
    ???????????????????????????????????
          ?
     ? Usuario hace clic "Procesar Pago"
     ?
          ?
    ???????????????????????????????????????????????????????
    ? confirmar-pago-bancario.addEventListener()          ?
    ? ?? Obtener cédula      ?
    ? ?? Validar no está vacía     ?
    ? ?? Llamar procesarPagoBancario()       ?
    ???????????????????????????????????????????????????????
         ?
       ?
    ???????????????????????????????????????????????????????
    ? realizarTransaccionBancaria()         ?
    ?          ?
    ? Datos:          ?
    ?   - cuenta_origen: 1750942508           ?
    ?   - cuenta_destino: 1700000000                ?
    ?   - monto: 150.00    ?
    ?        ?
    ? POST ? http://mibanca.runasp.net/api/Transacciones  ?
 ???????????????????????????????????????????????????????
      ?
        ?????????????????????
        ?         ?
   ?            ?
    ? ÉXITO  ? ERROR
    (200 OK)        (?200, error)
        ?           ?
?           ?
        ?     ????????????????????????
        ?     ? mostrarErrorPago...()?
        ?  ?             ?
        ?        ? Mostrar error?
  ?        ? Habilitar botón      ?
        ?? Mantener modal       ?
   ?        ????????????????????????
 ?             ?
        ?         ?
    ?        ????????????????????????
        ?        ? Usuario puede        ?
        ?   ? reintentar o         ?
        ?     ? cancelar             ?
        ?        ????????????????????????
        ?
        ?
    ????????????????????????????????????????????
    ? confirmarReservasConPagoBancario()        ?
    ?           ?
    ? POST ? /api/carrito/confirmar   ?
    ?   Body: {         ?
    ?     IdUsuario,        ?
    ?     ReservasIds,              ?
    ?     PromocionId,   ?
    ?     MetodoPago: "Transferencia Bancaria" ?
    ?   }?
    ????????????????????????????????????????????
 ?
    ?????????????????????????
    ?      ?
 ?      ?
 ? OK                 ? ERROR
    ?                 ?
    ?    ?
    ?        Mostrar error a usuario
    ?        (BD no guardó)
    ?
    ?
???????????????????????????????????????????
? ACTUALIZAR INTERFAZ        ?
?          ?
? - Mostrar mensaje de éxito        ?
? - Modal se cierra (3s)       ?
? - Spinner desaparece ?
? - Cargar carrito usuario  ?
? - Cargar reservas confirmadas  ?
???????????????????????????????????????????
    ?
    ?
????????????????????????????????????????????????????????
? RESULTADO FINAL           ?
?             ?
? Base de Datos:   ?
? ? Reserva.Estado = "CONFIRMADA"        ?
? ? Factura creada               ?
? ? Factura.MetodoPago = "Transferencia Bancaria"      ?
? ? Factura.Estado = "Pagada"      ?
? ? DetalleFactura con items           ?
?         ?
? Interfaz:  ?
? ? Carrito vacío o actualizado      ?
? ? Reserva aparece en "Confirmadas"        ?
? ? Método de pago visible    ?
?        ?
? Usuario:       ?
? ? Ve confirmación en pantalla   ?
? ? Recibe notificación (si activo)        ?
????????????????????????????????????????????????????????
```

---

## ??? ARQUITECTURA DE COMPONENTES

```
???????????????????????????????????????????????????????????????
?       CARRITO.HTML    ?
?        ?
?  ?????????????????????????????????????????????????????????? ?
?  ?  Bootstrap Modal: modalPagoBancario             ? ?
?  ?  ?? ID: modalPagoBancario                 ? ?
?  ?  ?? Input: cedula-cliente          ? ?
?  ?  ?? Display: monto-pago-bancario   ? ?
??  ?? Status: estado-pago-bancario       ? ?
?  ?  ?? Messages: mensaje-pago-bancario          ? ?
?  ?  ?? Button: confirmar-pago-bancario? ?
?  ?????????????????????????????????????????????????????????? ?
?    ?
?  ?????????????????????????????????????????????????????????? ?
?  ?  Button: btn-confirmar-carrito             ? ?
?  ?  (Abre modal de pago bancario)              ? ?
?  ?????????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????????
          ?
        ?
        ????????????????????????????????????
     ?       CARRITO.JS       ?
        ?     ?
      ?  setupEventListeners()           ?
        ?  ?? btn-confirmar-carrito        ?
        ?  ?? confirmar-pago-bancario      ?
        ?  ?? ...otros listeners      ?
        ?          ?
   ?  procesarPagoBancario()       ?
        ?  realizarTransaccionBancaria()   ?
        ?  confirmarReservasConPagoBancario?
        ?  mostrarErrorPagoBancario()      ?
      ?        ?
    ?  Variables globales:   ?
        ?  ?? usuario  ?
        ?  ?? reservasSeleccionadas     ?
  ?  ?? todasReservas       ?
     ?  ?? ...otras             ?
        ????????????????????????????????????
            ?
    ???????????????????????
        ?          ?
        ?   ?
    ??????????????      ????????????????????????
    ? API BANCO  ?      ?  API RESTAURANTE     ?
    ?   ?      ?            ?
    ? POST  ?      ? POST         ?
    ? /Transac.  ?      ? /carrito/confirmar   ?
    ?   ?      ?   ?
    ? Request:   ?      ? Request:        ?
    ? • origen   ?      ? • IdUsuario          ?
    ? • destino  ?      ? • ReservasIds        ?
    ? • monto    ?      ? • MetodoPago      ?
    ??????????????    ????????????????????????
        ?         ?
        ?      ?
    ??????????????      ????????????????????????
    ? mibanca    ?      ?  SQL SERVER          ?
    ? .runasp    ?      ?          ?
    ? .net  ?      ? INSERT/UPDATE:    ?
    ?     ?      ? • Reservas           ?
    ? Valida &   ?      ? • Facturas           ?
    ? Procesa?      ? • DetalleFactura     ?
    ? Transac.   ?      ?              ?
    ??????????????      ????????????????????????
```

---

## ?? SECUENCIA DE EVENTOS

```
Tiempo    Evento         Componente
?????????????????????????????????????????????????????????????
T0        Clic "Pagadas Ahora"Botón HTML
T1  setupEventListeners()       Event Listener
T2  procesarPagoBancario()    Función JS
T3     Modal abierto           Bootstrap Modal
T4        Usuario ingresa cédula      Input HTML
T5      Clic "Procesar Pago"        Botón modal
T6        Validación      JS función
T7        Spinner visible    CSS + JS
T8 POST a API banco     fetch()
T9        Esperando respuesta         Network
T10   Respuesta recibida          fetch callback
T11       Validar respuesta        JS lógica
T12POST a API carrito      fetch()
T13       Esperar confirmación        Network
T14    Actualizar BD    SQL Server
T15       Cargar carrito     API call
T16       Modal cierra        Bootstrap
T17       Interfaz actualizada        DOM update
```

---

## ?? CAMINOS DE DECISIÓN

```
???????????????????????????????????
? Inicio: procesarPagoBancario()  ?
???????????????????????????????????
   ?
  ?
    ???????????????????
    ?¿Hay cédula?     ?
    ??????????????????
      SÍ?       ?NO
    ?       ?
    ?    ? Mostrar: "Ingresa cédula"
        ?       ??? (return)
        ?
        ?
 ????????????????????????
    ?¿Hay reservas?     ?
    ????????????????????????
      SÍ?  ?NO
        ?         ?
 ?    ? Mostrar: "Selecciona reservas"
    ?  ??? (return)
        ?
        ?
    Calcular monto
      ?
   ?
    POST a banco
     ?
    ??????????????????????????????
    ? ¿Respuesta 200?         ?
    ??????????????????????????????
      SÍ?  ?NO
     ?      ?
        ?    ? mostrarErrorPago...()
        ?        ?
        ?          ??? return
        ?
        ?
    ? Respuesta exitosa
        ?
        ?
    POST a carrito/confirmar
        ?
  ????????????????????????
    ? ¿Éxito en BD?        ?
    ????????????????????????
      SÍ?   ?NO
        ?   ?
        ?  ? mostrarError()
        ?    ??? return
      ?
  ?
    ? Actualizar interfaz
        ?
        ?
    Mostrar mensaje éxito
        ?
    ?
    Cerrar modal (3s)
        ?
        ?
    FIN: Reserva confirmada
```

---

## ??? ESTRUCTURA DE DATOS

```
Usuario (localStorage)
{
  IdUsuario: 1,
  Nombre: "Juan",
  Email: "juan@email.com",
  Cedula: "1234567890",
  ...
}

Reserva (todasReservas)
{
  IdReserva: 101,
  IdUsuario: 1,
  NumeroMesa: 5,
  Fecha: "2024-01-15",
  Hora: "19:00",
  NumeroPersonas: 4,
  Subtotal: 100.00,
  MontoDescuentoCalculado: 10.00,
  IVA: 6.30,
  TotalFinal: 96.30
}

Transacción Bancaria (POST)
{
  cuenta_origen: "1750942508",
  cuenta_destino: "1700000000",
  monto: 96.30
}

Request Carrito (POST /api/carrito/confirmar)
{
IdUsuario: 1,
  ReservasIds: "101,102",
  PromocionId: null,
  MetodoPago: "Transferencia Bancaria"
}
```

---

## ? PUNTOS CLAVE

```
?? Entrada
   ?? Clic botón "Pagadas Ahora"

?? Procesamiento
   ?? Validar datos
   ?? Calcular monto
   ?? Conectar a API banco
   ?? Procesar transacción
   ?? Confirmar en BD

?? Salida
   ?? Reserva CONFIRMADA en BD
   ?? Factura PAGADA en BD
   ?? MetodoPago registrado
   ?? Interfaz actualizada

? Resultado
   ?? Usuario ve reserva en "Confirmadas"
```

